/**
 * autoNumeric.js
 * @author: Bob Knothe
 * @author: Sokolov Yura aka funny_falcon
 * @version: 1.7.0
 *
 * Copyright (c) 2010 Robert J. Knothe  http://www.decorplanit.com/plugin/
 * Copyright (c) 2010 Sokolov Yura aka funny_falcon http://github.com/funny_falcon/auto_numeric_js
 *
 * The MIT License (http://www.opensource.org/licenses/mit-license.php)
 */
(function(g){function v(a,c){g.each(c,function(b,d){if(typeof d==="function")c[b]=d(c,b);else if(typeof d==="string"){var e=d.substr(0,4);if(e=="fun:"){e=g.autoNumeric[d.substr(4)];c[b]=typeof e==="function"?g.autoNumeric[d.substr(4)](c,b):null}else if(e=="css:")c[b]=g(d.substr(4)).val()}})}function m(a,c){if(typeof a[c]==="string")a[c]*=1}function l(a,c){var b=g.extend({},g.fn.autoNumeric.defaults,c);if(g.metadata)b=g.extend(b,a.metadata());v(a,b);var d=b.vMax.toString().split("."),e=!b.vMin&&b.vMin!==
0?[]:b.vMin.toString().split(".");m(b,"vMax");m(b,"vMin");m(b,"mDec");b.aNeg=b.vMin<0?"-":"";if(typeof b.mDec!=="number")b.mDec=Math.max((d[1]?d[1]:"").length,(e[1]?e[1]:"").length);if(b.altDec===null&&b.mDec>0)if(b.aDec=="."&&b.aSep!=",")b.altDec=",";else if(b.aDec==","&&b.aSep!=".")b.altDec=".";d=b.aNeg?"(\\"+b.aNeg+"?)":"()";b._aNegReg=d;b._skipFirst=RegExp(d+"[^"+(b.aNeg?"\\"+b.aNeg:"")+"\\"+b.aDec+"\\d].*?(\\d|\\"+b.aDec+"\\d)");b._skipLast=RegExp("(\\d\\"+b.aDec+"?)[^\\"+b.aDec+"\\d]\\D*$");
e=b.aNeg+b.aNum+b.aDec;if(b.altDec)e+=b.altDec;b._allowed=RegExp("[^"+e+"]","gi");b._numReg=RegExp(d+"(?:\\"+b.aDec+"?(\\d+\\"+b.aDec+"\\d+)|(\\d*(?:\\"+b.aDec+"\\d*)?))");return b}function j(a,c,b){if(c.aSign)for(;a.indexOf(c.aSign)>-1;)a=a.replace(c.aSign,"");a=a.replace(c._skipFirst,"$1$2");a=a.replace(c._skipLast,"$1");a=a.replace(c._allowed,"");if(c.altDec)a=a.replace(c.altDec,c.aDec);a=(a=a.match(c._numReg))?[a[1],a[2],a[3]].join(""):"";if(b){c="^"+c._aNegReg+"0*(\\d"+(b==="leading"?")":"|$)");
c=RegExp(c);a=a.replace(c,"$1$2")}return a}function r(a,c,b){if(c&&b){var d=a.split(c);if(d[1]&&d[1].length>b)if(b>0){d[1]=d[1].substring(0,b);a=d.join(c)}else a=d[0]}return a}function n(a,c,b){if(c&&c!==".")a=a.replace(c,".");if(b&&b!=="-")a=a.replace(b,"-");a.match(/\d/)||(a+="0");return a}function s(a,c,b){if(b&&b!=="-")a=a.replace("-",b);if(c&&c!==".")a=a.replace(".",c);return a}function o(a,c){a=j(a,c);a=r(a,c.aDec,c.mDec);a=n(a,c.aDec,c.aNeg);var b=a*1;return b>=c.vMin&&b<=c.vMax}function p(a,
c){a=j(a,c);if(a===""||a==c.aNeg)return c.wEmpty=="zero"?a+"0":c.wEmpty=="sign"?a+c.aSign:a;var b="";b=c.dGroup==2?/(\d)((\d)(\d{2}?)+)$/:c.dGroup==4?/(\d)((\d{4}?)+)$/:/(\d)((\d{3}?)+)$/;var d=a.split(c.aDec);if(c.altDec&&d.length==1)d=a.split(c.altDec);var e=d[0];if(c.aSep)for(;b.test(e);)e=e.replace(b,"$1"+c.aSep+"$2");if(c.mDec!==0&&d.length>1){if(d[1].length>c.mDec)d[1]=d[1].substring(0,c.mDec);a=e+c.aDec+d[1]}else a=e;if(c.aSign){b=a.indexOf(c.aNeg)!==-1;a=a.replace(c.aNeg,"");a=c.pSign=="p"?
c.aSign+a:a+c.aSign;if(b)a=c.aNeg+a}return a}function t(a,c,b,d){a=a===""?"0":a+="";var e="",f=0,i="";if(a.charAt(0)=="-"){i=a*1===0?"":"-";a=a.replace("-","")}if(a*1>0)for(;a.substr(0,1)=="0"&&a.length>1;)a=a.substr(1);f=a.lastIndexOf(".");if(f===0){a="0"+a;f=1}if(f==-1||f==a.length-1)if(d&&c>0){e=f==-1?a+".":a;for(f=0;f<c;f++)e+="0";return i+e}else return i+a;var h=a.length-1-f;if(h==c)return i+a;if(h<c&&d){e=a;for(f=h;f<c;f++)e+="0";return i+e}d=f+c;h=a.charAt(d+1)*1;var k=[];for(f=0;f<=d;f++)k[f]=
a.charAt(f);a=a.charAt(d)=="."?a.charAt(d-1)%2:a.charAt(d)%2;if(h>4&&b==="S"||h>4&&b==="A"&&i===""||h>5&&b==="A"&&i=="-"||h>5&&b==="s"||h>5&&b==="a"&&i===""||h>4&&b==="a"&&i=="-"||h>5&&b==="B"||h==5&&b==="B"&&a==1||h>0&&b==="C"&&i===""||h>0&&b==="F"&&i=="-"||h>0&&b==="U")for(f=k.length-1;f>=0;f--)if(k[f]!="."){k[f]++;if(k[f]<10)break}for(f=0;f<=d;f++)e+=k[f]=="."||k[f]<10||f===0?k[f]:"0";if(c===0)e=e.replace(".","");return i+e}function u(a,c){this.options=c;this.that=a;this.$that=g(a);this.formatted=
false;this.io=l(this.$that,this.options);this.value=a.value}function q(a){if(typeof a=="string"){a=a.replace(/\[/g,"\\[").replace(/\]/g,"\\]");a="#"+a.replace(/(:|\.)/g,"\\$1")}return g(a)}g.extend(u.prototype,{init:function(a){this.value=this.that.value;this.io=l(this.$that,this.options);this.cmdKey=a.metaKey;this.shiftKey=a.shiftKey;var c=this.that,b={};if(c.selectionStart===undefined){c.focus();var d=document.selection.createRange();b.length=d.text.length;d.moveStart("character",-c.value.length);
b.end=d.text.length;b.start=b.end-b.length}else{b.start=c.selectionStart;b.end=c.selectionEnd;b.length=b.end-b.start}this.selection=b;if(a.type=="keydown"||a.type=="keyup")this.kdCode=a.keyCode;this.which=a.which;this.formatted=this.processed=false},setSelection:function(a,c,b){a=Math.max(a,0);c=Math.min(c,this.that.value.length);this.selection={start:a,end:c,length:c-a};if(b===undefined||b){b=this.that;a=a;c=c;if(b.selectionStart===undefined){b.focus();b=b.createTextRange();b.collapse(true);b.moveEnd("character",
c);b.moveStart("character",a);b.select()}else{b.selectionStart=a;b.selectionEnd=c}}},setPosition:function(a,c){this.setSelection(a,a,c)},getBeforeAfter:function(){var a=this.value,c=a.substring(0,this.selection.start);a=a.substring(this.selection.end,a.length);return[c,a]},getBeforeAfterStriped:function(){var a=this.getBeforeAfter();a[0]=j(a[0],this.io);a[1]=j(a[1],this.io);return a},normalizeParts:function(a,c){var b=this.io;c=j(c,b);var d=c.match(/^\d/)?true:"leading";a=j(a,b,d);if(a===""||a===
b.aNeg)if(c>"")c=c.replace(/^0*(\d)/,"$1");d=a+c;if(b.aDec){var e=d.match(RegExp("^"+b._aNegReg+"\\"+b.aDec));if(e){a=a.replace(e[1],e[1]+"0");d=a+c}}if(b.wEmpty=="zero"&&(d==b.aNeg||d===""))a+="0";return[a,c]},setValueParts:function(a,c){var b=this.io,d=this.normalizeParts(a,c),e=d.join("");d=d[0].length;if(o(e,b)){e=r(e,b.aDec,b.mDec);if(d>e.length)d=e.length;this.value=e;this.setPosition(d,false);return true}return false},signPosition:function(){var a=this.io,c=a.aSign,b=this.that;if(c){c=c.length;
if(a.pSign=="p")return a.aNeg&&b.value&&b.value.charAt(0)==a.aNeg?[1,c+1]:[0,c];else{a=b.value.length;return[a-c,a]}}else return[1E3,-1]},expandSelectionOnSign:function(a){var c=this.signPosition(),b=this.selection;if(b.start<c[1]&&b.end>c[0])if((b.start<c[0]||b.end>c[1])&&this.value.substring(Math.max(b.start,c[0]),Math.min(b.end,c[1])).match(/^\s*$/))b.start<c[0]?this.setSelection(b.start,c[0],a):this.setSelection(c[1],b.end,a);else this.setSelection(Math.min(b.start,c[0]),Math.max(b.end,c[1]),
a)},checkPaste:function(){if(this.valuePartsBeforePaste!==undefined){var a=this.getBeforeAfter(),c=this.valuePartsBeforePaste;delete this.valuePartsBeforePaste;a[0]=a[0].substr(0,c[0].length)+j(a[0].substr(c[0].length),this.io);if(!this.setValueParts(a[0],a[1])){this.value=c.join("");this.setPosition(c[0].length,false)}}},skipAllways:function(a){var c=this.kdCode,b=this.which,d=this.cmdKey;if(c==17&&a.type=="keyup"&&this.valuePartsBeforePaste!==undefined){this.checkPaste();return false}if(c>=112&&
c<=123||c>=91&&c<=93||c>=9&&c<=31||c<8&&(b===0||b===c)||c==144||c==145||c==45)return true;if(d&&c==65)return true;if(d&&(c==67||c==86||c==88)){a.type=="keydown"&&this.expandSelectionOnSign();if(c==86)if(a.type=="keydown"||a.type=="keypress"){if(this.valuePartsBeforePaste===undefined)this.valuePartsBeforePaste=this.getBeforeAfter()}else this.checkPaste();return a.type=="keydown"||a.type=="keypress"||c==67}if(d)return true;if(c==37||c==39){b=this.io.aSep;d=this.selection.start;var e=this.that.value;
if(a.type=="keydown"&&b&&!this.shiftKey)if(c==37&&e.charAt(d-2)==b)this.setPosition(d-1);else c==39&&e.charAt(d)==b&&this.setPosition(d+1);return true}if(c>=34&&c<=40)return true;return false},processAllways:function(){var a;if(this.kdCode==8||this.kdCode==46){if(this.selection.length){this.expandSelectionOnSign(false);a=this.getBeforeAfterStriped()}else{a=this.getBeforeAfterStriped();if(this.kdCode==8)a[0]=a[0].substring(0,a[0].length-1);else a[1]=a[1].substring(1,a[1].length)}this.setValueParts(a[0],
a[1]);return true}return false},processKeypress:function(){var a=this.io,c=String.fromCharCode(this.which),b=this.getBeforeAfterStriped(),d=b[0];b=b[1];if(c==a.aDec||a.altDec&&c==a.altDec){if(!a.mDec||!a.aDec)return true;if(a.aNeg&&b.indexOf(a.aNeg)>-1)return true;if(d.indexOf(a.aDec)>-1)return true;if(b.indexOf(a.aDec)>0)return true;if(b.indexOf(a.aDec)===0)b=b.substr(1);this.setValueParts(d+a.aDec,b);return true}if(c=="-"||c=="+"){if(!a.aNeg)return true;if(d===""&&b.indexOf(a.aNeg)>-1){d=a.aNeg;
b=b.substring(1,b.length)}d=d.charAt(0)==a.aNeg?d.substring(1,d.length):c=="-"?a.aNeg+d:d;this.setValueParts(d,b);return true}if(c>="0"&&c<="9"){if(a.aNeg&&d===""&&b.indexOf(a.aNeg)>-1){d=a.aNeg;b=b.substring(1,b.length)}this.setValueParts(d+c,b);return true}return true},formatQuick:function(){var a=this.io,c=this.getBeforeAfterStriped(),b=p(this.value,this.io),d=b.length;if(b){c=c[0].split("");for(var e in c)if(c[e]===".")c[e]="\\.";e=RegExp("^.*?"+c.join(".*?"));if(e=b.match(e)){d=e[0].length;if((d===
0&&b.charAt(0)!=a.aNeg||d==1&&b.charAt(0)==a.aNeg)&&a.aSign&&a.pSign=="p")d=this.io.aSign.length+(b.charAt(0)=="-"?1:0)}else if(a.aSign&&a.pSign=="s")d-=a.aSign.length}this.that.value=b;this.setPosition(d);this.formatted=true}});g.fn.autoNumeric=function(a){return this.each(function(){var c=g(this),b=new u(this,a);if(b.io.aForm&&(this.value||b.io.wEmpty!="empty"))c.autoNumericSet(c.autoNumericGet(a),a);c.keydown(function(d){b.init(d);if(b.skipAllways(d))return b.processed=true;if(b.processAllways()){b.processed=
true;b.formatQuick();d.preventDefault();return false}else b.formatted=false;return true}).keypress(function(d){var e=b.processed;b.init(d);if(b.skipAllways(d))return true;if(e){d.preventDefault();return false}if(b.processAllways()||b.processKeypress()){b.formatQuick();d.preventDefault();return false}else b.formatted=false}).keyup(function(d){b.init(d);d=b.skipAllways(d);b.kdCode=0;delete b.valuePartsBeforePaste;if(d)return true;if(this.value==="")return true;b.formatted||b.formatQuick()}).bind("change focusout",
function(){var d=b.io,e=c.val();if(e!==""){e=j(e,d);if(o(e,d)){e=n(e,d.aDec,d.aNeg);e=t(e,d.mDec,d.mRound,d.aPad);e=s(e,d.aDec,d.aNeg)}else e=""}c.val(p(e,d))})})};g.autoNumeric={};g.autoNumeric.Strip=function(a,c){var b=l(q(a),c),d=q(a).val();d=j(d,b);d=n(d,b.aDec,b.aNeg);if(d*1===0)d="0";return d};g.autoNumeric.Format=function(a,c,b){c+="";a=l(q(a),b);c=t(c,a.mDec,a.mRound,a.aPad);c=s(c,a.aDec,a.aNeg);o(c,a)||(c="");return p(c,a)};g.fn.autoNumericGet=function(a){return g.fn.autoNumeric.Strip(this,
a)};g.fn.autoNumericSet=function(a,c){return this.val(g.fn.autoNumeric.Format(this,a,c))};g.autoNumeric.defaults={aNum:"0123456789",aSep:",",aDec:".",altDec:null,aSign:"",pSign:"p",aForm:false,mDec:null,vMax:"999999999.99",vMin:"0.00",wEmpty:"empty",dGroup:3,mRound:"S",aPad:true};g.fn.autoNumeric.defaults=g.autoNumeric.defaults;g.fn.autoNumeric.Strip=g.autoNumeric.Strip;g.fn.autoNumeric.Format=g.autoNumeric.Format})(jQuery);
